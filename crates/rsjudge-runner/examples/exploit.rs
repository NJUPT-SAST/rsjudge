use std::{path::PathBuf, process::Command};

use caps::{read, CapSet, Capability};
use rsjudge_runner::{require_caps, user::builder, RunAs};
use rsjudge_utils::command::check_output;

/// An attempt to exploit the runner by running a binary with a setuid call.
///
/// To run this example, make sure to compile `exploit_inner` and `normal`,
/// and set the capabilities on the `exploit` binary:
///
/// ```sh
/// cargo build --examples
/// sudo setcap 'cap_setuid+ep cap_setgid+ep cap_dac_read_search+ep' \
///   ../../target/debug/examples/exploit
/// ../../target/debug/examples/exploit
/// ```
fn main() -> anyhow::Result<()> {
    dbg!(read(None, CapSet::Ambient).unwrap());
    dbg!(read(None, CapSet::Effective).unwrap());
    dbg!(read(None, CapSet::Inheritable).unwrap());
    dbg!(read(None, CapSet::Permitted).unwrap());

    require_caps([
        Capability::CAP_SETUID,
        Capability::CAP_SETGID,
        Capability::CAP_DAC_READ_SEARCH,
    ])?;

    // Get the path to the examples.
    // This crate is located at crates/rsjudge-runner,
    // so we need to go up two levels to find the workspace root.
    let examples = PathBuf::from(env!("CARGO_MANIFEST_DIR"))
        .parent()
        .and_then(|p| p.parent())
        .ok_or_else(|| anyhow::anyhow!("cannot find crate root"))?
        .join("target/debug/examples");

    let exploit_inner = examples.join("exploit_inner");

    let status = check_output(Command::new(dbg!(exploit_inner)).run_as(builder()?)?)?;
    println!("{}", String::from_utf8_lossy(&status.stdout));
    println!("{}", String::from_utf8_lossy(&status.stderr));

    let normal = examples.join("normal");
    let status = check_output(Command::new(normal).run_as(builder()?)?)?;
    println!("{}", String::from_utf8_lossy(&status.stdout));
    println!("{}", String::from_utf8_lossy(&status.stderr));

    Ok(())
}
