// SPDX-License-Identifier: Apache-2.0

use std::path::PathBuf;

use capctl::FullCapState;
use rsjudge_runner::{user::builder, RunAs};
use rsjudge_utils::command::check_output;
use tokio::process::Command;

/// An attempt to exploit the runner by running a binary with a setuid call.
///
/// To run this example, make sure to compile `exploit_inner` and `normal`,
/// and set the capabilities on the `exploit` binary:
///
/// ```sh
/// cargo build --examples
/// sudo setcap 'cap_setuid+ep cap_setgid+ep cap_dac_read_search+ep' \
///   ../../target/debug/examples/exploit
/// ../../target/debug/examples/exploit
/// ```
#[tokio::main]
async fn main() -> anyhow::Result<()> {
    dbg!(FullCapState::get_current().unwrap());

    // Get the path to the examples.
    // This crate is located at crates/rsjudge-runner,
    // so we need to go up two levels to find the workspace root.
    let examples = PathBuf::from(env!("CARGO_MANIFEST_DIR"))
        .parent()
        .and_then(|p| p.parent())
        .ok_or_else(|| anyhow::anyhow!("cannot find crate root"))?
        .join("target/debug/examples");

    let exploit_inner = examples.join("exploit_inner");

    let status = check_output(Command::new(dbg!(exploit_inner)).run_as(builder()?)?).await?;
    println!("{}", String::from_utf8_lossy(&status.stdout));
    println!("{}", String::from_utf8_lossy(&status.stderr));

    let normal = examples.join("normal");
    let status = check_output(Command::new(normal).run_as(builder()?)?).await?;
    println!("{}", String::from_utf8_lossy(&status.stdout));
    println!("{}", String::from_utf8_lossy(&status.stderr));

    Ok(())
}
