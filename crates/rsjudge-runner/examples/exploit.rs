use std::{path::PathBuf, process::Command};

use caps::{has_cap, read, CapSet, Capability};
use rsjudge_runner::{user::builder, RunAs};

/// An attempt to exploit the runner by running a binary with a setuid call.
///
/// To run this example, make sure to compile `exploit_inner` and `normal`,
/// and set the capabilities on the `exploit` binary:
///
/// ```sh
/// cargo build --examples
/// sudo setcap 'cap_setuid+ep cap_setgid+ep cap_dac_read_search+ep' \
///   ../../target/debug/examples/exploit
/// ../../target/debug/examples/exploit
/// ```
fn main() -> anyhow::Result<()> {
    dbg!(read(None, CapSet::Ambient).unwrap());
    dbg!(read(None, CapSet::Effective).unwrap());
    dbg!(read(None, CapSet::Inheritable).unwrap());
    dbg!(read(None, CapSet::Permitted).unwrap());

    if !has_cap(None, CapSet::Permitted, Capability::CAP_SETUID)?
        || !has_cap(None, CapSet::Permitted, Capability::CAP_SETGID)?
        || !has_cap(None, CapSet::Permitted, Capability::CAP_DAC_READ_SEARCH)?
    {
        eprintln!("Not all required capabilities are set, exiting.");
        return Err(anyhow::anyhow!("Missing required capabilities."));
    }

    // Get the path to the examples.
    // This crate is located at crates/rsjudge-runner,
    // so we need to go up two levels to find the workspace root.
    let examples = PathBuf::from(env!("CARGO_MANIFEST_DIR"))
        .parent()
        .and_then(|p| p.parent())
        .ok_or_else(|| anyhow::anyhow!("cannot find crate root"))?
        .join("target/debug/examples");

    let exploit_inner = examples.join("exploit_inner");

    let status = Command::new(dbg!(exploit_inner))
        .run_as(builder()?)
        .output()?;
    assert!(status.status.success());
    println!("{}", String::from_utf8_lossy(&status.stdout));
    println!("{}", String::from_utf8_lossy(&status.stderr));

    let normal = examples.join("normal");
    let status = Command::new(normal).run_as(builder()?).output()?;
    assert!(status.status.success());
    println!("{}", String::from_utf8_lossy(&status.stdout));
    println!("{}", String::from_utf8_lossy(&status.stderr));

    Ok(())
}
